---
title: "Lista 2"
author: "Álvaro Kothe, Giovanni Piccirilli, Larissa Eleutério, Marcos Andrade"
date: "21/09/2021"
output: pdf_document
---

```{r, message=F, warning=F}
## importando pacote e dados necessários

library(nlme)
data("Orthodont")
data = Orthodont

```


## Exercício 1

Cosidere a base Orthodont, ajuste o modelos misto da distância em função da idade e do sexo, com o efeito aleatório sujeito, considerando o método ML e REML. Observe se existe diferenças.

**Resposta:**

Primeiramente ajustamos o modelo pelo método da máxima verossimilhança.


```{r}

## ajustando um modelo de efeitos fixos pelo método da máxima verossimilhança
lmeML1=lme(fixed= distance~age + Sex, random=~ 1 |Subject, method="ML",data=data) 

## resultados
lmeML1

```

As estimativas dos parâmetros são:

* intercepto: 17,7
* idade: 0,66
* sexo: caso 
* desvio padrão dos resíduos: 1.4
* desvio padrão do efeito aleatório: 1,7


Ajustando agora o modelo com o método da máxima verossimilhança restrita vemos que a estimativa dos parâmetros se mantêm, exceto pela estimativa do desvio do efeito aleatório que agora é estimado em 1.8.

```{r}

## ajustando um modelo de efeitos fixos pelo método da máxima verossimilhança restrita
lmeREML1=lme(fixed= distance~age + Sex, random=~ 1 |Subject, method="REML",data=data)

## resultados
summary(lmeREML1)

```




## Exercício 2 
Refaça o item anterior considerando outra parametrização.

**Resposta:**

A parametrização padrão para variáveis categóricas no pacote nlme é a casela de referência, onde crianças do sexo masculino foram marcadas com '0' e crianças do sexo femenino como '1'.


```{r}

lmeML1$contrasts

```

Agora iremos alterar a parametricação para contraste da soma, onde o sexo masculino aparece como '1' e o sexo feminino como '-1'.

Ajustando o modelo com estimativa de máxima verossimilhança para os parâmetros vemos que apenas as estimativas do intercepto e do coeficiente associado ao fator fixo de idade se alteram. As demais estimativas se mantêm iguais ao modelo ajustado pela máxima verissimilhança com a parametrização casela de referência.

```{r}
lmeML2=lme(fixed= distance~age + Sex, random=~ 1 |Subject, method="ML",data=data,
           contrasts = list(Sex = "contr.sum")) 

summary(lmeML2)
lmeML2$contrasts

```

Similar a situação anterior, quando comparamos as estimativas do modelo estimado com máxima verossimilhança restrita, e diferença na parametrização de sexo, apenas intercepto e estimativa de coeficiente associado ao sexo são diferentes.


```{r}

lmeREML2=lme(fixed= distance~age + Sex, random=~ 1 |Subject, method="REML",data=data,
             contrasts = list(Sex = "contr.sum")) 

summary(lmeREML2)


```


## Exercício 3

Considerando valores próximos as estimativas de ML para os parâmetros fixos e de REML para as componentes de variância, simule duas novas bases de dados, uma em que o número de meninos é 32 e o de meninas é 22, e outra em que o número de meninos é 96 e o de meninas 33.


**Resposta:**


```{r}
age = 0.6
sex = -2.5
intercepto = 17
sigmab = 1.85^2 #o summary solta o desvio padrão
sigma = 1.45^2
set.seed(2109)
#Para 32 meninos e 22 meninas
head(data)
X = model.matrix(~age + Sex, data)
X2 = rbind(X,X) #Dobrei a matrix X
beta1 = c(intercepto, age, sex)
muv = X2%*%beta1
Zi = matrix(1,4,1) #matriz dos efeitos aletorios de cada individuo i (são iguais
#para todo i)
Vi = sigma*(diag(4)) + sigmab*(Zi%*%(t(Zi))) # Matriz de variância para indiv i
V = kronecker(diag(27*2), Vi) #matriz de variancia geral, essa multiplicação
#cria uma matriz quadrada em que cada elemento da diagonal é Vi
library(MASS)
y = mvrnorm(1, muv, V) #simulando da normal multivariada
individuo = rep(seq(1:54),each = 4) #gerando o indice dos individuos
datasim2 = data.frame(cbind(y, X2, individuo))
head(datasim2)
names(datasim2) = c("y","Intercept", "age", "Sex","Subject")
table(datasim2$Sex)/4
lmeML1=lme(fixed= y~age + Sex, random=~ 1 |Subject, method="ML",data=datasim2) 
lmeML1$sigma
lmeML1$coefficients$fixed

lmeREML1=lme(fixed= y~age + Sex, random=~ 1 |Subject, method="REML",data=datasim2) 
lmeREML1$sigma
lmeREML1$coefficients$fixed
```

```{r}
#Para 96 meninos e 32 meninas

X = model.matrix(~age + Sex, data)
Xmale = X[X[,3] == 0,]
Xmale = matrix(rep(t(Xmale), 6), ncol = ncol(Xmale), byrow = TRUE)
nrow(Xmale)/4
Xfemale = X[X[,3] == 1,]
Xfemale = matrix(rep(t(Xfemale), 3), ncol = ncol(Xfemale), byrow = TRUE)
nrow(Xfemale)/4

X3 = rbind(Xmale, Xfemale)
beta1 = c(intercepto, age, sex)
muv = X3%*%beta1
Zi = matrix(1,4,1)
Z = kronecker(diag(129), Zi)
Vi = sigma*(diag(4)) + sigmab*(Zi%*%(t(Zi)))
V = kronecker(diag(129), Vi)
library(MASS)
y = mvrnorm(1, muv, V)
individuo = rep(seq(1:129),each = 4)
datasim3 = data.frame(cbind(y, X3, individuo))
head(datasim3)
names(datasim3) = c("y","Intercept", "age", "Sex","Subject")
lmeML2=lme(fixed= y~age + Sex, random=~ 1 |Subject, method="ML",data=datasim3) 
lmeML2$sigma
lmeML2$coefficients$fixed
```

